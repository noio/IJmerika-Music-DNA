<html>
<head>

  <script src="http://connect.facebook.net/en_US/all.js" type="text/javascript"></script>
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js" type="text/javascript"></script>
  <title>My music DNA</title>

</head>
<body>

  <div id="fb-root"></div>
    <script>
    function fb_login(){      
        FB.login(function(response){
            console.log("Logged in, getting artists.")
            // Hier starten we met zoeken
            fb_set_info(response);
            get_liked_artists(response);
            print_friends_liked_artists(response);
            // FB.logout() // Laat gebruiker zien dat het is uitgelogd
        }, {scope: 'user_likes,friends_likes'});
    }
    
    function fb_set_info(response){
        window.user_id = response.authResponse['userID'];
        window.access_token = response.authResponse['accessToken'];
    }
    
    $(document).ready(function(){
        FB.init({
          appId      : '150298645114656', // App ID
          channelUrl : '//localhost:8083/channel.html', // Channel File
          status     : true, // check login status
          cookie     : true, // enable cookies to allow the server to access the session
          xfbml      : true  // parse XFBML
        });

        FB.getLoginStatus(function(r){
          if(r.status=='connected'){
            // Al ingelogd
            console.log("User already logged in, logging out.")
            fb_set_info(r);
            // FB.logout();
            get_liked_artists(r);
          }
        });
    });

    function get_liked_artists(data){
        
        request_url = 'https://graph.facebook.com/'+user_id+"/likes?access_token="+access_token;
        
        $.getJSON(request_url, function(data, status){
            if(status=="success"){
                // krijg de lijst van namen
                artists = $.map(data['data'], function(v,k){if(v.category=='Musician/band'){return v.name}});
            
                // stuur ze naar de appengine
                $.post('/store_artists_for_user', {user_id: window.user_id, artists: JSON.stringify(artists)});
              
            }else{
              console.log("The request for user's likes went bad: "+status)
            }
        });

    }
    
    function print_friends_liked_artists(data){
        request_url = 'https://graph.facebook.com/'+user_id+"/friends?access_token="+access_token;

        $.getJSON(request_url, function(data, status){
            if(status=="success"){
                
                console.log(data);
                window.all_friends_artists = [];
                $.each( data.data , function(idx, el){
                    request_url = 'https://graph.facebook.com/'+el.id+"/likes?access_token="+access_token;
                
                    $.getJSON(request_url, function(data, status){
                        if(status=="success"){
                            console.log(el.name)
                            artists = $.map(data['data'], function(v,k){if(v.category=='Musician/band'){return v.name}});
                            if (artists.length > 0){
                                console.log(artists);
                                window.all_friends_artists = window.all_friends_artists.concat(artists);
                            } else {
                                console.log("NO DATA");
                            }
                        }
                    }); 
                });
            }              
        });
    }
      

  </script>

  <!-- <div class="fb-login-button" data-show-faces="false" data-width="200" data-max-rows="1" data-scope="user_events"></div> -->
  
  <a href="#" onclick="fb_login();return false;">Login</a>

</body>
</html>